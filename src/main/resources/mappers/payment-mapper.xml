<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="payment">
		
	<select id="resList" resultType="PaymentReqDto">
		SELECT (SELECT MODEL FROM VEHICLE WHERE IDX = TB_P.VEHICLE_IDX) AS VEHICLE_MODEL
             , (SELECT NAME FROM LOCATION WHERE IDX = TB_P.RETURN_LOCATION) AS RETURN_LOCATION_NAME
             , (SELECT NAME FROM LOCATION WHERE IDX = TB_P.RENT_LOCATION) AS RENT_LOCATION_NAME
             , TB_P.*
		  FROM PAYMENT TB_P
		 WHERE MEMBER_IDX IN (SELECT IDX FROM MEMBER WHERE USERNAME = #{username}) AND STATE = 0	
	</select>
	
	
	<select id="ReservationOne" resultType="PaymentReqDto" >
		 SELECT (SELECT NAME FROM INSURANCE WHERE IDX = TB_P.INSURANCE_IDX) AS INSURANCE_NAME
			, (SELECT NAME FROM LOCATION WHERE IDX = TB_P.RENT_LOCATION) AS RENT_LOCATION_NAME
			, (SELECT NAME FROM LOCATION WHERE IDX = TB_P.RETURN_LOCATION) AS RETURN_LOCATION_NAME
			,(SELECT MODEL FROM VEHICLE WHERE IDX = TB_P.VEHICLE_IDX) AS VEHICLE_MODEL
			, (SELECT PRICE FROM INSURANCE WHERE IDX = TB_P.INSURANCE_IDX) AS PRICE
		 	, TB_P.*
		 FROM PAYMENT TB_P
		  WHERE idx = #{idx}
	</select>
	
	<select id="selectNoneM" resultType="PaymentReqDto">
		SELECT *
		  FROM NMEMPAYMENT
		 WHERE PAYMENT_IDX = #{paymentIdx} AND NAME = #{name} AND PHONE_NUMBER = #{phoneNumber}
	</select>
		
		
	<select id="noneMemberRes" resultType="PaymentReqDto">
		SELECT (SELECT MODEL FROM VEHICLE WHERE IDX = TB_P.VEHICLE_IDX) AS VEHICLE_MODEL
			, (SELECT NAME FROM LOCATION WHERE IDX = TB_P.RENT_LOCATION) AS RENT_LOCATION_NAME
			, (SELECT NAME FROM LOCATION WHERE IDX = TB_P.RETURN_LOCATION) AS RETURN_LOCATION_NAME
		 	, TB_P.*
		 	FROM PAYMENT TB_P
		 	WHERE IDX IN ( SELECT PAYMENT_IDX FROM NMEMPAYMENT WHERE PAYMENT_IDX = #{paymentIdx} )
		  
	</select>
	
	
	<select id="reservLocation" resultType="LocationRespDto">
		SELECT NAME, PHONE_NUMBER, BUSINESS_HOURS, ADDRESS FROM LOCATION WHERE IDX IN (SELECT RENT_LOCATION FROM PAYMENT WHERE IDX = #{idx} )
	</select>
	
	<update id="deleteReserv" >
		 UPDATE PAYMENT SET STATE = 1 , CANCEL_DATE = TO_CHAR(SYSDATE, 'YYYY-MM-DD') WHERE IDX = #{idx} 
	
	</update>
	
	
	<insert id="insertPayInfo" parameterType="PaymentReqDto" >
		INSERT INTO PAYMENT(IDX, STATE, MEMBER_IDX, VEHICLE_IDX, INSURANCE_IDX, COUPON_IDX, FINAL_PRICE, PAID_TIME, START_DATE, END_DATE, CANCEL_DATE, RENT_LOCATION,RETURN_LOCATION, IS_MEMBER )
		VALUES(PAYMENT_SEQ.NEXTVAL, 0, #{memberIdx}, #{vehicleIdx}, #{insuranceIdx}, #{couponIdx}, #{finalPrice}, SYSDATE, #{startDate}, #{endDate}, DEFAULT, #{rentLocation}, #{returnLocation}, #{ismember})
	</insert>
	
	<update id="updateCoupon" parameterType="PaymentReqDto">
		UPDATE COUPON SET STATUS =1 WHERE IDX =#{couponIdx}
	</update>
		
	<insert id ="insertNmemInfo" parameterType="PaymentReqDto" >
		INSERT INTO NMEMPAYMENT(PAYMENT_IDX, NAME, BIRTH, PHONE_NUMBER, LICENSE, EMAIL) 
		VALUES(PAYMENT_SEQ.CURRVAL, #{name}, #{birth}, #{phoneNumber}, #{license}, #{email})
	</insert>

	<select id="reservByModel" resultType="adminReservByModelRespDto">
		SELECT *
		  FROM (SELECT ROWNUM RNUM, PAY.*
		          FROM (SELECT V.MODEL, COUNT(*) CNT, SUM(FINAL_PRICE) SUM
                          FROM PAYMENT P INNER JOIN VEHICLE V ON P.VEHICLE_IDX = V.IDX
                         GROUP BY V.MODEL ORDER BY SUM DESC) PAY)
         WHERE RNUM BETWEEN 1 AND 5
	</select>
	
	<select id="selectList" resultType="adminReservRespDto">
		SELECT *
		  FROM (SELECT ROWNUM AS RNUM, IDX, IS_MEMBER, STATE, FINAL_PRICE, PAID_TIME, CANCEL_DATE, START_DATE, END_DATE
		          FROM PAYMENT ORDER BY IDX DESC)
         WHERE RNUM BETWEEN #{start} AND #{end}
	</select>
	
	<select id="count" resultType="_int">
		SELECT COUNT(*) FROM PAYMENT
	</select>
	
	<select id="recentMonth" resultType="adminStatisticsRecentMonthDto">
		SELECT *
		  FROM (SELECT (SELECT LOCATION.IDX FROM LOCATION WHERE LOCATION.IDX = PAYMENT.RENT_LOCATION) 
                               AS IDX , EXTRACT(MONTH FROM PAID_TIME) AS PAID_TIME, FINAL_PRICE FROM PAYMENT WHERE CANCEL_DATE IS NULL)
                         PIVOT (SUM(FINAL_PRICE) FOR IDX IN (1 AS LOC1, 2 AS LOC2, 3 AS LOC3, 4 AS LOC4, 5 AS LOC5))
         WHERE PAID_TIME >= (SELECT EXTRACT(MONTH FROM SYSDATE) - 2 FROM DUAL)
         ORDER BY PAID_TIME
	</select>
	
	<select id="monthList" resultType="map">
		SELECT EXTRACT(MONTH FROM PAID_TIME) || 'ì›”' AS MONTH
		  FROM PAYMENT GROUP BY EXTRACT(MONTH FROM PAID_TIME)
		HAVING EXTRACT(MONTH FROM PAID_TIME) >= (SELECT EXTRACT(MONTH FROM SYSDATE) FROM DUAL) - 2
         ORDER BY MONTH
	</select>

	
	<select id="dayReservCount" resultType="_int">
		SELECT COUNT(*) AS CNT
		  FROM PAYMENT
		 WHERE TO_CHAR(PAID_TIME,'YY/MM/DD') = TO_DATE(SYSDATE, 'YY/MM/DD') AND CANCEL_DATE IS NULL
	</select>
	
	<select id="dayReservSum" resultType="_int">
		SELECT NVL(SUM(FINAL_PRICE), 0) AS SUM
	      FROM PAYMENT
	     WHERE TO_CHAR(PAID_TIME,'YY/MM/DD') = TO_DATE(SYSDATE, 'YY/MM/DD') AND CANCEL_DATE IS NULL
	</select>
	
	<select id="selectOneForAdmin" resultType="adminReservOneRespDto">
		SELECT IDX, STATE, IS_MEMBER, FINAL_PRICE, PAID_TIME, START_DATE, END_DATE, CANCEL_DATE
		     , (SELECT USERNAME FROM MEMBER WHERE IDX = MEMBER_IDX) AS USERNAME
		     , (SELECT MODEL FROM VEHICLE WHERE IDX = VEHICLE_IDX) AS MODEL
		     , (SELECT NAME FROM INSURANCE WHERE IDX = INSURANCE_IDX) AS INSURANCE
		     , (SELECT NAME FROM COUPON_MANAGE WHERE IDX = COUPON_IDX) AS COUPON
             , (SELECT NAME FROM LOCATION WHERE IDX = RENT_LOCATION) AS RENT_LOCATION
             , (SELECT NAME FROM LOCATION WHERE IDX = RETURN_LOCATION) AS RETURN_LOCATION
          FROM PAYMENT WHERE IDX = #{idx}
	</select>
	
</mapper>
